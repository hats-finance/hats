import { useCallback, useContext, useEffect, useState } from "react";
import MDEditor from '@uiw/react-md-editor';
import download from "downloadjs";
import classNames from "classnames";
import { useVaults } from "hooks/useVaults";
import { Colors } from "constants/constants";
import { encryptWithKeys } from "pages/VulnerabilityFormPage/encrypt";
import { VulnerabilityFormContext } from "pages/VulnerabilityFormPage/state";
import "styles/Vulnerability/Description.scss";

export default function VulnerabilityDescription() {
  const { vulnerabilyData, setVulnerabilyData } = useContext(VulnerabilityFormContext);
  const [title, setTitle] = useState("");
  const [description, setDescription] = useState("");
  const { vaults } = useVaults();
  const vault = vaults?.find(vault => vault.id === vulnerabilyData?.project?.projectId)!;

  const editorStyles = {
    color: Colors.white
  }

  useEffect(() => {
    setTitle(vulnerabilyData?.description?.title || "");
    setDescription(vulnerabilyData?.description?.description || "");
  }, [vulnerabilyData]);

  const handleSaveDescription = useCallback(async () => {
    if (!vault.description?.["communication-channel"]["pgp-pk"]) return;
    const keyOrKeys = vault.description?.["communication-channel"]["pgp-pk"]!;
    const textToDownload = `
    **Project Name:** ${vulnerabilyData?.project?.projectName}
    **Title:** ${title}
    **Description:** ${description}
    **Telegram username:** ${vulnerabilyData?.contact?.username}  
    **Beneficiary:** ${vulnerabilyData?.contact?.beneficiary}
    `;
    const { encryptedData, sessionKey } = await encryptWithKeys(keyOrKeys, textToDownload);
    download(JSON.stringify({ text: textToDownload, sessionKey }), `${title}.json`);
    setVulnerabilyData(prev => {
      if (!prev || !title || !description) return prev;
      return {
        ...prev,
        description: {
          verified: true,
          title, description,
          encryptedData: encryptedData as string,
          sessionKey
        }
      };
    })
  }, [vulnerabilyData, description, title, vault, setVulnerabilyData])

  return (
    <div className="description-wrapper">
      <input className={classNames({ "input-error": title === "" })} autoFocus type="text" placeholder="Title" onChange={(e) => setTitle(e.target.value)} value={title} />
      <MDEditor
        className={classNames({ "input-error": description === "" })}
        style={editorStyles}
        value={description}
        onChange={value => setDescription(value!)}
      />

      <button
        className="save-and-download-btn"
        disabled={title === "" || description === ""}
        onClick={handleSaveDescription}>SAVE AND DOWNLOAD</button>
    </div>
  )
}
